rules:
  - id: hardcoded-api-key
    pattern-either:
      - pattern: |
          const $KEY = "$VALUE"
      - pattern: |
          let $KEY = "$VALUE"
      - pattern: |
          var $KEY = "$VALUE"
      - pattern: |
          $KEY = "$VALUE"
      - pattern: |
          const $KEY = '$VALUE'
      - pattern: |
          let $KEY = '$VALUE'
      - pattern: |
          var $KEY = '$VALUE'
      - pattern: |
          $KEY = '$VALUE'
    metavariable-regex:
      metavariable: $KEY
      regex: (?i).*(api[_-]?key|secret|password|token|auth|credential|private[_-]?key|access[_-]?key).*
    message: Potential hardcoded API key or secret detected
    severity: ERROR
    languages: [typescript, javascript]
    metadata:
      category: security
      cwe: "CWE-798"
      owasp: "A02:2021 - Cryptographic Failures"
      fix: Store secrets in environment variables, not in code

  - id: sql-string-concatenation
    pattern-either:
      - pattern: |
          $DB.query($X + $Y)
      - pattern: |
          $DB.execute($X + $Y)
      - pattern: |
          $DB.query("..." + $VAR + "...")
      - pattern: |
          $DB.execute("..." + $VAR + "...")
      - pattern: |
          $DB.raw(`...${$VAR}...`)
      - pattern: |
          $DB.query(`...${$VAR}...`)
    message: Potential SQL injection - avoid string concatenation in queries
    severity: ERROR
    languages: [typescript, javascript]
    metadata:
      category: security
      cwe: "CWE-89"
      owasp: "A03:2021 - Injection"
      fix: Use parameterized queries or prepared statements

  - id: dangerous-inner-html
    pattern-either:
      - pattern: $ELEMENT.innerHTML = $X
      - pattern: $ELEMENT.outerHTML = $X
      - pattern: document.write($X)
      - pattern: document.writeln($X)
    message: Potential XSS vulnerability - avoid using innerHTML with dynamic content
    severity: WARNING
    languages: [typescript, javascript]
    metadata:
      category: security
      cwe: "CWE-79"
      owasp: "A03:2021 - Injection"
      fix: Use textContent, innerText, or a sanitization library like DOMPurify

  - id: command-injection-risk
    pattern-either:
      - pattern: exec($X + $Y)
      - pattern: execSync($X + $Y)
      - pattern: spawn($CMD, [..., $VAR, ...])
      - pattern: exec(`...${$VAR}...`)
      - pattern: execSync(`...${$VAR}...`)
    message: Potential command injection vulnerability
    severity: ERROR
    languages: [typescript, javascript]
    metadata:
      category: security
      cwe: "CWE-78"
      owasp: "A03:2021 - Injection"
      fix: Validate and sanitize all inputs, avoid shell execution with user input

  - id: path-traversal-risk
    pattern-either:
      - pattern: readFile($X + $Y, ...)
      - pattern: readFileSync($X + $Y, ...)
      - pattern: writeFile($X + $Y, ...)
      - pattern: writeFileSync($X + $Y, ...)
      - pattern: fs.readFile($PATH + $INPUT, ...)
      - pattern: fs.readFileSync($PATH + $INPUT, ...)
    message: Potential path traversal vulnerability
    severity: WARNING
    languages: [typescript, javascript]
    metadata:
      category: security
      cwe: "CWE-22"
      owasp: "A01:2021 - Broken Access Control"
      fix: Validate file paths and use path.join() with sanitization

  - id: weak-crypto-algorithm
    pattern-either:
      - pattern: crypto.createHash("md5")
      - pattern: crypto.createHash('md5')
      - pattern: crypto.createHash("sha1")
      - pattern: crypto.createHash('sha1')
      - pattern: createHash("md5")
      - pattern: createHash('md5')
      - pattern: createHash("sha1")
      - pattern: createHash('sha1')
    message: Weak cryptographic algorithm detected (MD5/SHA1)
    severity: WARNING
    languages: [typescript, javascript]
    metadata:
      category: security
      cwe: "CWE-327"
      owasp: "A02:2021 - Cryptographic Failures"
      fix: Use SHA-256, SHA-384, or SHA-512 instead

  - id: prototype-pollution
    pattern-either:
      - pattern: $OBJ.__proto__ = $X
      - pattern: $OBJ["__proto__"] = $X
      - pattern: $OBJ['__proto__'] = $X
      - pattern: $OBJ.constructor.prototype = $X
    message: Potential prototype pollution vulnerability
    severity: ERROR
    languages: [typescript, javascript]
    metadata:
      category: security
      cwe: "CWE-1321"
      owasp: "A08:2021 - Software and Data Integrity Failures"
      fix: Use Object.create(null) or Object.freeze() to prevent prototype pollution

  - id: unsafe-regex-construction
    pattern-either:
      - pattern: new RegExp($X + $Y)
      - pattern: RegExp($X + $Y)
      - pattern: new RegExp(`...${$VAR}...`)
      - pattern: RegExp(`...${$VAR}...`)
    message: Unsafe regular expression construction - potential ReDoS
    severity: WARNING
    languages: [typescript, javascript]
    metadata:
      category: security
      cwe: "CWE-1333"
      owasp: "A06:2021 - Vulnerable Components"
      fix: Avoid user-controlled regex patterns, use fixed patterns

  - id: weak-random-generation
    pattern: Math.random()
    message: Math.random() is not cryptographically secure
    severity: INFO
    languages: [typescript, javascript]
    metadata:
      category: security
      cwe: "CWE-338"
      owasp: "A02:2021 - Cryptographic Failures"
      fix: Use crypto.randomBytes() for security-sensitive operations

  - id: open-redirect
    pattern-either:
      - pattern: window.location = $REQ.query.$X
      - pattern: window.location.href = $REQ.query.$X
      - pattern: res.redirect($REQ.query.$X)
      - pattern: res.redirect($REQ.params.$X)
    message: Potential open redirect vulnerability
    severity: WARNING
    languages: [typescript, javascript]
    metadata:
      category: security
      cwe: "CWE-601"
      owasp: "A01:2021 - Broken Access Control"
      fix: Validate redirect URLs against an allowlist

  - id: permissive-cors
    pattern-either:
      - pattern: |
          cors({ origin: "*" })
      - pattern: |
          cors({..., origin: "*", ...})
      - pattern: |
          "Access-Control-Allow-Origin": "*"
      - pattern: |
          'Access-Control-Allow-Origin': '*'
    message: Overly permissive CORS configuration
    severity: INFO
    languages: [typescript, javascript]
    metadata:
      category: security
      cwe: "CWE-942"
      owasp: "A05:2021 - Security Misconfiguration"
      fix: Restrict CORS to specific trusted origins

  - id: sensitive-data-in-storage
    pattern-either:
      - pattern: localStorage.setItem("...token...", ...)
      - pattern: localStorage.setItem("...password...", ...)
      - pattern: localStorage.setItem("...secret...", ...)
      - pattern: sessionStorage.setItem("...token...", ...)
      - pattern: sessionStorage.setItem("...password...", ...)
      - pattern: sessionStorage.setItem("...secret...", ...)
    message: Storing sensitive data in browser storage
    severity: WARNING
    languages: [typescript, javascript]
    metadata:
      category: security
      cwe: "CWE-922"
      owasp: "A04:2021 - Insecure Design"
      fix: Use httpOnly cookies or secure server-side sessions

  - id: eval-usage
    pattern-either:
      - pattern: eval($X)
      - pattern: Function($X)
      - pattern: setTimeout($X, ...)
      - pattern: setInterval($X, ...)
    message: Avoid using eval() or Function constructor - code injection risk
    severity: ERROR
    languages: [typescript, javascript]
    metadata:
      category: security
      cwe: "CWE-95"
      owasp: "A03:2021 - Injection"
      fix: Use safe alternatives, avoid executing dynamic code

  - id: console-log-in-production
    pattern-either:
      - pattern: console.log(...)
      - pattern: console.debug(...)
      - pattern: console.info(...)
    message: Console logging detected - may leak sensitive information
    severity: INFO
    languages: [typescript, javascript]
    metadata:
      category: security
      cwe: "CWE-532"
      owasp: "A09:2021 - Security Logging Failures"
      fix: Remove console logs or use proper logging library in production

  - id: jwt-none-algorithm
    pattern-either:
      - pattern: |
          jwt.sign(..., {algorithm: "none"})
      - pattern: |
          jwt.sign(..., {algorithm: 'none'})
      - pattern: |
          jwt.verify(..., ..., {algorithms: ["none"]})
    message: JWT with 'none' algorithm is insecure
    severity: ERROR
    languages: [typescript, javascript]
    metadata:
      category: security
      cwe: "CWE-327"
      owasp: "A02:2021 - Cryptographic Failures"
      fix: Use strong algorithms like RS256, HS256

  - id: hardcoded-credentials
    pattern-either:
      - pattern: |
          const password = "..."
      - pattern: |
          let password = "..."
      - pattern: |
          var password = "..."
      - pattern: |
          const passwd = "..."
      - pattern: |
          const pwd = "..."
    message: Hardcoded password detected
    severity: ERROR
    languages: [typescript, javascript]
    metadata:
      category: security
      cwe: "CWE-798"
      owasp: "A07:2021 - Identification and Authentication Failures"
      fix: Use environment variables or secure credential management
